!function(t){function e(s){if(i[s])return i[s].exports;var n=i[s]={exports:{},id:s,loaded:!1};return t[s].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){window.PEWVR={},i(1),i(2),i(3),i(5),i(6),i(7),i(8),i(9),i(10),i(11),i(12),i(13),i(14),i(15),i(16),i(17),i(18),i(19),i(21),i(22),i(23),i(24),i(25),i(26),i(27),i(28),i(29),i(30),i(31)},function(t,e){AFRAME.registerElement("a-asset-image",{prototype:Object.create(AFRAME.ANode.prototype,{createdCallback:{value:function(){this.isAssetItem=!0}},attachedCallback:{value:function(){var t=this.getAttribute("src"),e=new THREE.ImageLoader;e.load(t,this.onImageLoaded.bind(this))}},onImageLoaded:{value:function(){AFRAME.ANode.prototype.load.call(this)}}})})},function(t,e){function i(t,e,i){var s=document.createElement("a-mixin");s.setAttribute("id",t),Object.keys(e).forEach(function(t){var i=e[t];"object"==typeof i&&(i=AFRAME.utils.styleParser.stringify(i)),s.setAttribute(t,i)});var n=i?i.querySelector("a-assets"):document.querySelector("a-assets");return n||(n=document.createElement("a-assets"),i.appendChild(n)),n.appendChild(s),s}Number.prototype.padLeft=function(t,e){return Array(t-String(this).length+1).join(e||"0")+this},String.prototype.pad=function(t,e,i){var s=String(this).substr(0,t),n=Array(t-s.length+1).join(i||" ");return e?n+this:this+n},t.exports={createMixin:i}},function(t,e,i){var s=i(4);PEWVR.BULLETS={},PEWVR.registerBullet=function(t,e,i){if(PEWVR.BULLETS[t])throw new Error("The bullet `"+t+"` has been already registered. Check that you are not loading two versions of the same bullet or two different bullets of the same name.");PEWVR.BULLETS[t]={poolSize:e.poolSize,components:e.components,definition:i},console.info("Bullet registered ",t)},AFRAME.registerSystem("bullet",{init:function(){var t=this;this.poolHelper=new s("bullet",PEWVR.BULLETS,this.sceneEl),this.activeBullets=[],this.sceneEl.addEventListener("gamestate-changed",function(e){"state"in e.detail.diff&&("STATE_GAME_OVER"!==e.detail.state.state&&"STATE_GAME_WIN"!==e.detail.state.state||t.reset())})},reset:function(t){var e=this;this.activeBullets.forEach(function(t){e.returnBullet(t.getAttribute("bullet").name,t)})},returnBullet:function(t,e){this.activeBullets.splice(this.activeBullets.indexOf(e),1),this.poolHelper.returnEntity(t,e)},getBullet:function(t){var e=this.poolHelper.requestEntity(t);return this.activeBullets.push(e),e}})},function(t,e,i){var s=i(2).createMixin,n=function(t,e,i){this.groupName=t,this.sceneEl=i||document.querySelector("a-scene"),this.initializePools(t,e)};n.prototype={initializePools:function(t,e){var i=this;Object.keys(e).forEach(function(n){var o=e[n],a=o.components,r=t+n;s(r,a,i.sceneEl),i.sceneEl.setAttribute("pool__"+r,{size:o.poolSize,mixin:r,dynamic:!0})})},returnEntity:function(t,e){var i=this.groupName+t,s="pool__"+i;this.sceneEl.components[s].returnEntity(e)},requestEntity:function(t){var e=this.groupName+t,i="pool__"+e,s=this.sceneEl.components[i].requestEntity();return s}},t.exports=n},function(t,e,i){var s=i(4);PEWVR.ENEMIES={},PEWVR.registerEnemy=function(t,e,i){if(PEWVR.ENEMIES[t])throw new Error("The enemy `"+t+"` has been already registered. Check that you are not loading two versions of the same enemy or two different enemies of the same name.");PEWVR.ENEMIES[t]={poolSize:e.poolSize,components:e.components,definition:i,name:t},console.info("Enemy registered ",t)},AFRAME.registerSystem("enemy",{schema:{wave:{default:0}},init:function(){var t=this,e=this.sceneEl;return e.hasLoaded?(this.poolHelper=new s("enemy",PEWVR.ENEMIES,this.sceneEl),this.activeEnemies=[],void e.addEventListener("gamestate-changed",function(e){if("state"in e.detail.diff)if("STATE_PLAYING"===e.detail.state.state)setTimeout(function(){t.createWave(0)},1e3);else if("STATE_GAME_OVER"===e.detail.state.state||"STATE_GAME_WIN"===e.detail.state.state||"STATE_MAIN_MENU"===e.detail.state.state)return void t.reset();"waveSequence"in e.detail.diff&&t.createSequence(e.detail.state.waveSequence),"wave"in e.detail.diff&&t.createWave(e.detail.state.wave)})):void e.addEventListener("loaded",this.init.bind(this))},getEnemy:function(t){return this.poolHelper.requestEntity(t)},onEnemyDeath:function(t,e){"STATE_MAIN_MENU"===this.sceneEl.getAttribute("gamestate").state?this.sceneEl.emit("start-game"):(this.poolHelper.returnEntity(t,e),this.sceneEl.emit("enemy-death"))},createSequence:function(t){var e=this,i=this.currentWave.sequences[t].start||0;setTimeout(function(){e.currentSequence=t;var i=e.currentWave.sequences[t];i.enemies.forEach(function(t){e.createEnemies(t)})},i)},createWave:function(t){this.currentWave=WAVES[t%WAVES.length],this.createSequence(0),this.sceneEl.emit("wave-created",{wave:this.currentWave})},createEnemy:function(t,e,i){function s(t){t.setAttribute("visible",!0),t.components["curve-movement"].addPoints(e.points),t.play(),n.activeEnemies.push(t),n.sceneEl.emit("enemy-spawn",{enemy:t})}var n=this,o=this.getEnemy(t);o.setAttribute("enemy",{shootingDelay:3e3}),o.setAttribute("curve-movement",{type:e.movement,loopStart:e.loopStart||1,timeOffset:i||0}),i?i<0&&(o.setAttribute("visible",!1),setTimeout(function(){s(o)},-i)):s(o)},createEnemies:function(t){if(Array.isArray(t.type))for(var e=0;e<t.type.length;e++){var i=t.type[e],s=(t.enemyTimeOffset||0)*e;this.createEnemy(i,t,s)}else this.createEnemy(t.type,t)},reset:function(t){var e=this;this.activeEnemies.forEach(function(t){e.poolHelper.returnEntity(t.getAttribute("enemy").name,t)})}})},function(t,e,i){var s=i(4);PEWVR.EXPLOSIONS={},PEWVR.registerExplosion=function(t,e,i){if(PEWVR.EXPLOSIONS[t])throw new Error("The explosion `"+t+"` has been already registered. Check that you are not loading two versions of the same explosion or two different enemies of the same name.");PEWVR.EXPLOSIONS[t]={poolSize:e.poolSize,components:e.components,definition:i,name:t},console.info("Explosion registered ",t)},AFRAME.registerSystem("explosion",{schema:{wave:{default:0}},init:function(){this.poolHelper=new s("explosion",PEWVR.EXPLOSIONS,this.sceneEl),this.activeExplosions=[]},reset:function(t){var e=this;this.activeExplosions.forEach(function(t){e.returnToPool(t.getAttribute("explosion").name,t)})},returnToPool:function(t,e){this.activeExplosions.splice(this.activeExplosions.indexOf(e),1),this.poolHelper.returnEntity(t,e)},getFromPool:function(t){var e=this.poolHelper.requestEntity(t);return this.activeExplosions.push(e),e},createExplosion:function(t,e,i,s,n,o){var a=this.getFromPool(t);a.setAttribute("position",e||this.el.getAttribute("position")),a.setAttribute("explosion",{type:t,lookAt:n.clone(),color:i||"#FFF",scale:s||1}),a.setAttribute("visible",!0),a.play()}}),PEWVR.registerExplosion("enemy",{components:{explosion:{type:"enemy"}},poolSize:10},{}),PEWVR.registerExplosion("enemygun",{components:{explosion:{type:"enemygun"}},poolSize:10},{}),PEWVR.registerExplosion("bullet",{components:{explosion:{type:"bullet"}},poolSize:10},{}),PEWVR.registerExplosion("background",{components:{explosion:{type:"background"}},poolSize:10},{})},function(t,e){PEWVR.registerBullet("default",{components:{bullet:{name:"default",maxSpeed:1,initialSpeed:.1,acceleration:.4,color:"#ffc724"},"collision-helper":{debug:!1,radius:.2},"json-model":{src:"#playerBullet"}},poolSize:10},{init:function(){var t=this.el,e=this.bullet.components.bullet.color;t.setAttribute("material","color",e),t.setAttribute("scale",{x:.2,y:.2,z:.2}),this.trail=null;var i=this;t.addEventListener("model-loaded",function(t){i.trail=i.el.getObject3D("mesh").getObjectByName("trail"),i.trail.scale.setY(.001)})},reset:function(){var t=this.el;t.setAttribute("scale",{x:.2,y:.2,z:.2}),this.trail&&this.trail.scale.setY(.001)},tick:function(t,e){if(this.trail&&this.trail.scale.y<1){var i;i=this.trail.scale.y<.005?this.trail.scale.y+.001:this.trail.scale.y+e/50,i>1&&(i=1),this.trail.scale.setY(i)}},onHit:function(t){this.el.setAttribute("material","color","#FFF")}})},function(t,e){PEWVR.registerEnemy("enemy_start",{components:{enemy:{name:"enemy_start",color:"#FFB911",scale:.1,health:1},"collision-helper":{debug:!1,radius:.4},"json-model":{src:"url(assets/models/target.json)",texturePath:"url(assets/images/)",singleModel:!0}},poolSize:1},{init:function(){this.shootingDelay=3e3,this.warmUpTime=1e3,this.reset()},reset:function(){var t=this.el,e=this.data.scale;t.addEventListener("model-loaded",function(i){t.getObject3D("mesh").scale.set(e,e,e)}),this.lastShoot=void 0,this.willShootEmited=!1},tick:function(t,e){},onHit:function(t){}})},function(t,e){PEWVR.registerEnemy("enemy0",{components:{enemy:{name:"enemy0",bulletName:"enemy-slow",color:"#FFB911",scale:.9,health:1},"collision-helper":{debug:!1,radius:.4},"json-model":{src:"#enemy0",texturePath:"url(assets/images/)",singleModel:!0}},poolSize:10},{init:function(){this.shootingDelay=3e3,this.warmUpTime=1e3,this.reset()},reset:function(){var t=this.el,e=this.data.scale;this.actualShootingDelay=this.shootingDelay+Math.floor(this.shootingDelay*Math.random()),t.addEventListener("model-loaded",function(i){t.getObject3D("mesh").scale.set(e,e,e)}),this.lastShoot=void 0,this.willShootEmited=!1},tick:function(t,e){void 0==this.lastShoot&&(this.lastShoot=t)},onHit:function(t){}})},function(t,e){AFRAME.registerComponent("proxy_event",{schema:{event:{default:""},dst:{type:"selector"},bubbles:{default:!1}},init:function(){this.el.sceneEl.addEventListener(this.data.event,function(t){this.data.dst.emit(this.data.event,t,this.data.bubbles)}.bind(this))}})},function(t,e){AFRAME.registerComponent("countdown",{schema:{start:{default:"01:00"},value:{default:"00:00"},autostart:{default:!1}},init:function(){this.timeinterval=null,this.data.autostart&&this.restart();var t=this;this.el.sceneEl.addEventListener("gamestate-changed",function(e){if("state"in e.detail.diff)switch(e.detail.state.state){case"STATE_PLAYING":t.restart();break;case"STATE_GAME_OVER":case"STATE_GAME_WIN":case"STATE_MAIN_MENU":t.stop()}})},initializeClock:function(t){function e(){var e=Date.parse(t)-Date.parse(new Date),s=Math.floor(e/1e3%60),n=Math.floor(e/1e3/60%60),o={total:e,minutes:n,seconds:s};i.el.sceneEl.emit("countdown-update",o),o.total<=0&&(clearInterval(i.timeinterval),i.el.sceneEl.emit("countdown-end"))}var i=this;this.el.sceneEl.emit("countdown-start",t),this.timeinterval=setInterval(e,1e3),e()},stop:function(){clearInterval(this.timeinterval),this.el.sceneEl.emit("countdown-update",{total:0,minutes:0,seconds:0})},restart:function(){this.stop();var t=this.data.start.split(":").map(function(t){return parseInt(t)}),e=new Date(Date.parse(new Date)+1e3*(60*t[0]+t[1]));this.initializeClock(e)}})},function(t,e){AFRAME.registerSystem("decals",{schema:{size:{default:.1},src:{default:"",type:"asset"},maxDecals:{default:30}},init:function(){this.numDecals=0,this.decals=[],this.oldestDecalIdx=0,this.textureSrc=null,this.geometry=new THREE.PlaneGeometry(1,1),this.material=new THREE.MeshBasicMaterial({transparent:!0,color:"#ffc724",depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-20}),this.updateMap()},updateMap:function(){function t(t){this.material.map=t,this.material.needsUpdate=!0}var e=this.data.src;if(e){if(e===this.textureSrc)return;return this.textureSrc=e,void this.sceneEl.systems.material.loadTexture(e,{src:e},t.bind(this))}this.material.map&&t(null)},update:function(t){this.updateMap()},getDecal:function(){var t=this.data.maxDecals,e=this.data.size,i=null;return 0===t||this.numDecals<t?(i=new THREE.Mesh(this.geometry,this.material),this.numDecals++,this.decals.push(i)):(i=this.decals[this.oldestDecalIdx],this.oldestDecalIdx=(this.oldestDecalIdx+1)%this.data.maxDecals),i.scale.set(e,e,e),i},addDecal:function(t,e){var i=this.getDecal();i&&(i.position.set(0,0,0),i.position.copy(t),i.lookAt(e),i.rotation.z+=Math.random()*Math.PI*2,this.sceneEl.object3D.add(i))}})},function(t,e){function i(t){return.5*(1-Math.cos(Math.PI*t))}function s(t){function e(t,e,i,s,n,o,a){var r=.5*(i-t),l=.5*(s-e);return(2*(e-i)+r+l)*a+(-3*(e-i)-2*r-l)*o+r*n+e}var i=new THREE.Spline(t);return i.getPointFrom=function(t,i){var s,n,o,a,r,l,h,c,d,u,m;return l=this.points,h=i+t,s=[],s[0]=0===i?i:i-1,s[1]=i,s[2]=i>l.length-2?l.length-1:i+1,s[3]=i>l.length-3?l.length-1:i+2,n=l[s[0]],o=l[s[1]],a=l[s[2]],r=l[s[3]],m=h-i,c=m*m,d=m*c,u={},u.x=e(n.x,o.x,a.x,r.x,m,c,d),u.y=e(n.y,o.y,a.y,r.y,m,c,d),u.z=e(n.z,o.z,a.z,r.z,m,c,d),u},i.getPointFrom=i.getPointFrom.bind(i),i}THREE.Spline=function(t){function e(t,e,i,s,n,o,a){var r=.5*(i-t),l=.5*(s-e);return(2*(e-i)+r+l)*a+(-3*(e-i)-2*r-l)*o+r*n+e}this.points=t;var i,s,n,o,a,r,l,h,c,d=[],u={x:0,y:0,z:0};this.initFromArray=function(t){this.points=[];for(var e=0;e<t.length;e++)this.points[e]={x:t[e][0],y:t[e][1],z:t[e][2]}},this.getPoint=function(t){return i=(this.points.length-1)*t,s=Math.floor(i),n=i-s,d[0]=0===s?s:s-1,d[1]=s,d[2]=s>this.points.length-2?this.points.length-1:s+1,d[3]=s>this.points.length-3?this.points.length-1:s+2,r=this.points[d[0]],l=this.points[d[1]],h=this.points[d[2]],c=this.points[d[3]],o=n*n,a=n*o,u.x=e(r.x,l.x,h.x,c.x,n,o,a),u.y=e(r.y,l.y,h.y,c.y,n,o,a),u.z=e(r.z,l.z,h.z,c.z,n,o,a),u},this.getControlPointsArray=function(){var t,e,i=this.points.length,s=[];for(t=0;t<i;t++)e=this.points[t],s[t]=[e.x,e.y,e.z];return s},this.getLength=function(t){var e,i,s,n,o=0,a=0,r=0,l=new THREE.Vector3,h=new THREE.Vector3,c=[],d=0;for(c[0]=0,t||(t=100),s=this.points.length*t,l.copy(this.points[0]),e=1;e<s;e++)i=e/s,n=this.getPoint(i),h.copy(n),d+=h.distanceTo(l),l.copy(n),o=(this.points.length-1)*i,a=Math.floor(o),a!==r&&(c[a]=d,r=a);return c[c.length]=d,{chunks:c,total:d}},this.reparametrizeByArcLength=function(t){var e,i,s,n,o,a,r,l,h=[],c=new Vector3,d=this.getLength();for(h.push(c.copy(this.points[0]).clone()),e=1;e<this.points.length;e++){for(a=d.chunks[e]-d.chunks[e-1],r=Math.ceil(t*a/d.total),n=(e-1)/(this.points.length-1),o=e/(this.points.length-1),i=1;i<r-1;i++)s=n+i*(1/r)*(o-n),l=this.getPoint(s),h.push(c.copy(l).clone());h.push(c.copy(this.points[e]).clone())}this.points=h}},AFRAME.registerComponent("curve-movement",{schema:{debug:{default:!1},type:{default:"single"},restTime:{default:150},speed:{default:3},loopStart:{default:1},timeOffset:{default:0}},init:function(){this.direction=1},isClosed:function(){return"loop"===this.data.type},addPoints:function(t){var e,i,n=this.data;"loop"===n.type&&(t=t.slice(0),t.push(t[this.data.loopStart])),e=this.spline=s(),e.initFromArray(t),this.currentPointIndex=0,i=e.getLength().chunks,this.cycleTimes=i.map(function(t,e){return 0===e?null:(t-i[e-1])/n.speed*1e3}).filter(function(t){return null!==t}),this.time=this.data.timeOffset,this.initTime=null,this.restTime=0,this.direction=1,this.end=!1},update:function(){var t=this.data,e=this.el;t.debug?e.setAttribute("spline-line",{pointer:"movement-pattern.movementPattern.spline"}):e.removeAttribute("spline-line")},play:function(){this.time=this.data.timeOffset,this.initTime=null},tick:function(t,e){var s,n,o,a=this.data,r=this.el,l=this.spline;if(this.initTime||(this.initTime=t),!this.end&&(this.isClosed()||this.currentPointIndex!==l.points.length-1)){s=this.cycleTimes[this.currentPointIndex];var h=0,c=!1;if(this.time>s?(h=1,c=!0):h=this.time/s,this.direction===-1&&(h=1-h),n="single"===a.type?i(h):h,this.time=t-this.initTime,this.time<0)return void console.log(n);o=l.getPointFrom(n,this.currentPointIndex),r.setAttribute("position",{x:o.x,y:o.y,z:o.z}),this.lastPercent=n,c&&(1===this.direction?this.currentPointIndex===l.points.length-2?"single"===a.type?this.end=!0:"loop"===a.type?this.currentPointIndex=this.data.loopStart:this.direction=-1:this.currentPointIndex++:(this.currentPointIndex--,this.currentPointIndex<this.data.loopStart&&(this.currentPointIndex=this.data.loopStart,this.direction=1)),this.initTime=t,this.time=0)}}})},function(t,e){AFRAME.registerComponent("collision-helper",{schema:{type:{default:"sphere",oneOf:["sphere","box"]},radius:{default:1,if:{type:["sphere"]}},debug:{default:!1},color:{type:"color",default:8947848}},init:function(){var t=this.data;this.geometry=new THREE.IcosahedronGeometry(1,1),this.material=new THREE.MeshBasicMaterial({color:t.color,wireframe:!0}),this.helperMesh=null,t.debug&&this.createHelperMesh()},createHelperMesh:function(){var t=this.data.radius;this.helperMesh=new THREE.Mesh(this.geometry,this.material),this.helperMesh.visible=!0,this.helperMesh.scale.set(t,t,t),this.el.setObject3D("collision-helper-mesh",this.helperMesh)},update:function(t){var e=this.data;e.debug&&(this.helperMesh?(this.material.color.set(e.color),this.helperMesh.scale.set(e.radius,e.radius,e.radius),this.helperMesh.visible=e.debug):this.createHelperMesh())}})},function(t,e){PEWVR.currentScore={name:"",points:0,time:0,shoots:0,validShoot:0},AFRAME.registerComponent("gamestate",{schema:{health:{default:5},numEnemies:{default:0},numSequences:{default:0},points:{default:0},numEnemiesToWin:{default:100},isGameOver:{default:!1},isGameWin:{default:!1},state:{default:"STATE_MAIN_MENU",oneOf:["STATE_MAIN_MENU","STATE_PLAYING","STATE_GAME_OVER","STATE_GAME_WIN"]},wave:{default:0},waveSequence:{default:0}},gameEnd:function(t,e){t.state="STATE_GAME_WIN",t.isGameWin=!0},init:function(){function t(t,i){s.addEventListener(t,function(s){var n=i(AFRAME.utils.extend({},o),s);e(t,n)})}function e(t,e){var i=AFRAME.utils.extend({},o);s.setAttribute("gamestate",e),o=e,s.emit("gamestate-changed",{event:t,diff:AFRAME.utils.diff(i,e),state:e})}var i=this,s=this.el,n=this.initialState,o=this.data;n||(n=o),s.emit("gamestate-initialized",{state:n}),t("enemy-death",function(t){return t.points++,PEWVR.currentScore.points++,t.points>=i.data.numEnemiesToWin&&i.gameEnd(t,!0),t.numEnemies--,0===t.numEnemies&&(t.numSequences--,t.waveSequence++,0===t.numSequences&&(t.waveSequence=0,t.wave++,t.wave>=WAVES.length&&i.gameEnd(t,!0))),t}),t("wave-created",function(t,e){var i=e.detail.wave;return t.numSequences=i.sequences.length,t.waveSequence=0,t}),t("enemy-spawn",function(t){return t.numEnemies++,t}),t("start-game",function(t){return t.isGameOver=!1,t.isGameWin=!1,t.state="STATE_PLAYING",t}),t("player-hit",function(t){return"STATE_PLAYING"===t.state&&(t.health-=1,t.health<=0&&(t.isGameOver=!0,t.numEnemies=0,t.state="STATE_GAME_OVER")),t}),t("reset",function(){return PEWVR.currentScore={name:"",points:0,time:0,shoots:0,validShoot:0},n})}}),AFRAME.registerComponent("gamestate-bind",{schema:{default:{},parse:AFRAME.utils.styleParser.parse},update:function(){var t=this.el.closestScene();t.hasLoaded&&this.updateBinders(),t.addEventListener("loaded",this.updateBinders.bind(this))},updateBinders:function(){function t(t){Object.keys(t).forEach(function(n){var o=e[n],a=t[n];s.indexOf(n)!==-1&&AFRAME.utils.entity.setComponentProperty(i,o,a)})}var e=this.data,i=this.el,s=Object.keys(this.data);i.sceneEl.addEventListener("gamestate-changed",function(e){t(e.detail.diff)}),i.sceneEl.addEventListener("gamestate-initialized",function(e){t(e.detail.state)})}})},function(t,e){function i(t){var e="DEBUG\n";return Object.keys(t).sort().forEach(function(i){e+=i+": "+t[i]+"\n"}),e}AFRAME.registerComponent("gamestate-debug",{init:function(){function t(t){e.setAttribute("bmfont-text",{text:i(t.detail.state),color:"#DADADA"})}var e=this.el,s=this.el.sceneEl;s.addEventListener("gamestate-initialized",t),s.addEventListener("gamestate-changed",t)}})},function(t,e){AFRAME.registerComponent("shoot-controls",{schema:{hand:{default:"left"}},init:function(){var t=this;this.onButtonChanged=this.onButtonChanged.bind(this),this.onButtonDown=function(e){t.onButtonEvent(e.detail.id,"down")},this.onButtonUp=function(e){t.onButtonEvent(e.detail.id,"up")}},play:function(){var t=this.el;t.addEventListener("buttonchanged",this.onButtonChanged),t.addEventListener("buttondown",this.onButtonDown),t.addEventListener("buttonup",this.onButtonUp)},pause:function(){var t=this.el;t.removeEventListener("buttonchanged",this.onButtonChanged),t.removeEventListener("buttondown",this.onButtonDown),t.removeEventListener("buttonup",this.onButtonUp)},mapping:{axis0:"trackpad",axis1:"trackpad",button0:"trackpad",button1:"trigger",button2:"grip",button3:"menu",button4:"system"},onButtonChanged:function(t){var e=this.mapping["button"+t.detail.id];if("trigger"===e){var i=t.detail.state.value;this.el.components.weapon.setTriggerPressure(i)}},onButtonEvent:function(t,e){var i=this.mapping["button"+t];this.el.emit(i+e)},update:function(){var t=this.data,e=this.el;e.setAttribute("vive-controls",{hand:t.hand,model:!1}),e.setAttribute("oculus-touch-controls",{hand:t.hand,model:!1}),e.setAttribute("windows-motion-controls",{hand:t.hand,model:!1}),"right"===t.hand&&(e.setAttribute("daydream-controls",{hand:t.hand,model:!1}),e.setAttribute("gearvr-controls",{hand:t.hand,model:!1}))}})},function(t,e){AFRAME.registerComponent("bullet",{schema:{name:{default:""},direction:{type:"vec3"},maxSpeed:{default:5},initialSpeed:{default:5},position:{type:"vec3"},acceleration:{default:.5},destroyable:{default:!1},owner:{default:"player",oneOf:["enemy","player"]},color:{default:"#fff"}},init:function(){this.startEnemy=document.getElementById("start_enemy"),this.backgroundEl=document.getElementById("border"),this.bullet=PEWVR.BULLETS[this.data.name],this.bullet.definition.init.call(this),this.hit=!1,this.direction=new THREE.Vector3,this.temps={direction:new THREE.Vector3,position:new THREE.Vector3}},update:function(t){var e=this.data;this.owner=this.data.owner,this.direction.set(e.direction.x,e.direction.y,e.direction.z),this.currentAcceleration=e.acceleration,this.speed=e.initialSpeed,this.startPosition=e.position},play:function(){this.initTime=null},hitObject:function(t,e){if(this.bullet.definition.onHit.call(this),this.hit=!0,"enemy"===this.data.owner)this.el.emit("player-hit");else if("bullet"===t)e.components.bullet.resetBullet(),this.el.sceneEl.systems.explosion.createExplosion(t,e.object3D.position,e.getAttribute("bullet").color,1,this.direction),PEWVR.currentScore.validShoot++;else if("background"===t){this.el.sceneEl.systems.decals.addDecal(e.point,e.face.normal);var i=e.point.clone().sub(this.direction.clone().multiplyScalar(.2));this.el.sceneEl.systems.explosion.createExplosion(t,i,"#fff",1,this.direction)}else if("enemy"===t){var s=e.getAttribute("enemy");e.components.enemy.health<=0?this.el.sceneEl.systems.explosion.createExplosion("enemy",e.object3D.position,s.color,s.scale,this.direction,s.name):this.el.sceneEl.systems.explosion.createExplosion("bullet",this.el.object3D.position,s.color,s.scale,this.direction),PEWVR.currentScore.validShoot++}this.resetBullet()},resetBullet:function(){this.hit=!1,this.bullet.definition.reset.call(this),this.initTime=null,this.direction.set(this.data.direction.x,this.data.direction.y,this.data.direction.z),this.currentAcceleration=this.data.acceleration,this.speed=this.data.initialSpeed,this.startPosition=this.data.position,this.system.returnBullet(this.data.name,this.el)},tick:function(){return function(t,e){this.initTime||(this.initTime=t),this.bullet.definition.tick.call(this,t,e),this.el.object3D.lookAt(this.direction.clone().multiplyScalar(1e3)),this.temps.position.copy(this.el.getAttribute("position")),this.speed=.1*this.currentAcceleration*e,this.speed>this.data.maxSpeed&&(this.speed=this.data.maxSpeed),this.temps.direction.copy(this.direction);var i=this.temps.position.add(this.temps.direction.multiplyScalar(this.speed));if(this.el.setAttribute("position",i),this.temps.position.length()>=50)return void this.resetBullet();var s=this.el.getAttribute("collision-helper");if(s){var n=s.radius;if("player"===this.data.owner){if("player"===this.data.owner){var o=this.el.sceneEl.getAttribute("gamestate").state;if("STATE_MAIN_MENU"===o){var a=this.startEnemy,r=a.getAttribute("collision-helper"),l=r.radius;if(i.distanceTo(a.object3D.position)<l+n)return this.el.sceneEl.systems.explosion.createExplosion("enemy",this.el.getAttribute("position"),"#ffb911",.5,this.direction,"enemy_start"),void a.emit("hit")}else if("STATE_GAME_WIN"===o||"STATE_GAME_OVER"===o){var a=document.getElementById("reset"),r=a.getAttribute("collision-helper"),l=r.radius;if(i.distanceTo(a.object3D.position)<2*l+2*n)return this.el.sceneEl.systems.explosion.createExplosion("enemy",this.el.getAttribute("position"),"#f00",.5,this.direction,"enemy_start"),void this.el.sceneEl.emit("reset")}else for(var h=this.el.sceneEl.systems.enemy.activeEnemies,c=0;c<h.length;c++){var a=h[c],r=a.getAttribute("collision-helper");if(r){var l=r.radius;if(i.distanceTo(a.object3D.position)<l+n)return a.emit("hit"),void this.hitObject("enemy",a)}}}}else{var d=this.el.sceneEl.camera.el.components["look-controls"].dolly.position;if(i.distanceTo(d)<.1+n)return void this.hitObject("player")}}}}()})},function(t,e,i){var s=i(20);AFRAME.registerComponent("timer-counter",{schema:{width:{default:.9},value:{default:""},numSegments:{default:5},height:{default:.35},color:{default:2411263}},init:function(){this.letterPanel=new s(this.el.sceneEl.systems.material,this.data),this.el.setObject3D("mesh",this.letterPanel.group);var t=this;this.el.sceneEl.addEventListener("countdown-update",function(e){var i=e.detail,s=i.minutes.padLeft(2)+":"+i.seconds.padLeft(2);t.letterPanel.material.color.set(i.total<=1e4?16711680:2411263),t.el.setAttribute("timer-counter",{value:s})})},update:function(){this.letterPanel.update(this.data.value)}})},function(t,e){function i(t,e){function i(t){this.material.map=t,this.material.needsUpdate=!0}this.width=e.width,this.height=e.height,this.numSegments=e.numSegments;var n="assets/images/font.png";t.loadTexture(n,{src:n},i.bind(this)),this.material=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,color:e.color,transparent:!0}),this.group=new THREE.Group;var o=this.width/this.numSegments;this.numLetters=s.length;for(var a=0;a<this.numSegments;a++)plane=new THREE.Mesh(new THREE.PlaneBufferGeometry(o,this.height),this.material),plane.position.x=a*o,this.group.add(plane)}var s="0123456789:* ";i.prototype={update:function(t){t=t.split("").map(function(t){return s.indexOf(t)});for(var e=1/this.numLetters,i=0;i<this.numSegments;i++){var n=this.group.children[i].geometry.attributes.uv,o=n.array,a=t[i]*e,r=(t[i]+1)*e;o[0]=a,o[4]=a,o[2]=r,o[6]=r,n.needsUpdate=!0}}},t.exports=i},function(t,e){AFRAME.registerComponent("enemy",{schema:{name:{default:"enemy0"},bulletName:{default:"enemy-slow"},shootingDelay:{default:200},health:{default:1},color:{default:"#fff"},scale:{default:1},canShoot:{default:!0}},init:function(){function t(t){this.gunGlowMaterial.alphaMap=t,this.gunGlowMaterial.needsUpdate=!0,this.gunGlowMaterial.visible=!0}this.alive=!0,this.hipBone=null,this.definition=PEWVR.ENEMIES[this.data.name].definition,this.definition.init.call(this);var e=PEWVR.ENEMIES[this.data.name].components.enemy;this.maxhealth=this.health=e.health,this.color=e.color,this.scale=e.scale,this.gunOffset=new THREE.Vector3(0,.44,.5).multiplyScalar(this.scale),this.lastShootTime=void 0,this.shootAt=0,this.warmUpTime=1e3,this.paused=!1;this.el.addEventListener("model-loaded",function(t){}),this.gunGlowMaterial=new THREE.MeshBasicMaterial({color:this.color,side:THREE.DoubleSide,transparent:!0,blending:THREE.AdditiveBlending,depthTest:!0,depthWrite:!1,visible:!1});var i=document.querySelector("#fx3").getAttribute("src");this.el.sceneEl.systems.material.loadTexture(i,{src:i},t.bind(this)),this.gunGlow=new THREE.Mesh(new THREE.PlaneGeometry(this.scale,this.scale),this.gunGlowMaterial),this.gunGlow.position.copy(this.gunOffset),this.el.setObject3D("glow",this.gunGlow),this.exploding=!1,this.explodingDuration=500+Math.floor(300*Math.random()),this.el.addEventListener("hit",this.collided.bind(this))},update:function(t){},play:function(){this.paused=!1},pause:function(){this.paused=!0},collided:function(){if(!this.exploding&&(this.health--,this.health<=0)){this.el.emit("enemy-hit"),this.exploding=!0;var t=this.el.getObject3D("mesh");this.whiteMaterial=new THREE.MeshBasicMaterial({color:this.color,transparent:!0}),t.normalMaterial=t.material,t.material=this.whiteMaterial,this.gunGlow.visible=!1,this.system.activeEnemies.splice(this.system.activeEnemies.indexOf(this.el),1)}},die:function(){this.alive=!1,this.reset(),this.system.onEnemyDeath(this.data.name,this.el)},reset:function(){var t=this.el.getObject3D("mesh");t&&(t.material.opacity=1,t.scale.set(this.scale,this.scale,this.scale),t.material=t.normalMaterial,this.gunGlow.visible=!0,this.gunGlow.scale.set(1,1,1),this.gunGlowMaterial.opacity=.3),this.el.setAttribute("scale","0.05 0.05 0.05"),this.explodingTime=void 0,this.lastShootTime=void 0,this.shootAt=0,this.warmUpTime=1e3,this.health=this.maxhealth,this.alive=!0,this.exploding=!1,this.definition.reset.call(this)},shoot:function(t,e){var i=this.el;if(i){var s=this.data,n=i.object3D,o=n.localToWorld(this.gunGlow.position.clone()),a=i.sceneEl.camera.el.components["look-controls"].dolly.position.clone(),r=a.sub(n.position).normalize();this.lastShootTime=t,this.gunGlow.scale.set(3,3,3),this.gunGlowMaterial.opacity=1,this.el.sceneEl.systems.explosion.createExplosion("enemygun",o,this.color,this.scale,r,this.data.name);var l=i.sceneEl.systems.bullet.getBullet(s.bulletName);l.setAttribute("bullet",{position:o,direction:r,owner:"enemy"}),l.setAttribute("position",o),l.setAttribute("visible",!0),l.play()}},willShoot:function(t,e,i){this.shootAt=t+i,this.warmUpTime=i},tick:function(t,e){if(this.alive&&!this.paused)if(this.exploding){this.explodingTime||(this.explodingTime=t);var i=(t-this.explodingTime)/this.explodingDuration,s=this.scale+i*(2-i),n=this.el.getObject3D("mesh");n.scale.set(s,s,s),n.material.opacity=Math.max(0,1-2.5*i),i>=1&&this.die()}else{var o=700;if(void 0===this.lastShootTime)this.lastShootTime=t;else if(this.shootAt-t<this.warmUpTime){this.gunGlowMaterial.opacity=(this.shootAt-t)/this.warmUpTime;var a=1+Math.abs(Math.sin(t/50));this.gunGlow.scale.set(a,a,a)}else t-this.lastShootTime<o&&(this.gunGlowMaterial.opacity=1-(t-this.lastShootTime)/o);this.gunGlow.position.copy(this.gunOffset),this.hipBone&&(this.gunGlow.position.y+=this.hipBone.position.y);var r=this.el.sceneEl.camera.el.components["look-controls"].dolly.position.clone();this.el.object3D.lookAt(r),this.definition.tick.call(this,t,e)}}})},function(t,e){var i={default:{model:{url:"url(assets/models/gun.json)",positionOffset:[0,0,0],rotationOffset:[0,0,0]},shootSound:"url(assets/sounds/gunshot.wav)",shootingDelay:100,bullet:"default"}};AFRAME.registerComponent("weapon",{dependencies:["shoot-controls"],schema:{enabled:{default:!0},type:{default:"default"}},updateWeapon:function(){console.log(this.controllerModel),"oculus-touch-controller"===this.controllerModel?(this.model.applyMatrix((new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(1,0,0),.8)),this.el.setAttribute("shoot",{direction:"0 -0.3 -1"})):"daydream-controls"===this.controllerModel&&(document.getElementById("rightHandPivot").setAttribute("position","-0.2 0 -0.5"),this.el.setAttribute("shoot",{on:"trackpaddown"}))},init:function(){var t=this.el,e=this;this.model=null,this.isGamepadConnected=!1,this.controllerModel=null,this.weapon=i[this.data.type],t.setAttribute("json-model",{src:this.weapon.model.url}),t.setAttribute("sound",{src:this.weapon.shootSound,on:"shoot",volume:.5,poolSize:10}),this.fires=[],this.trigger=null,t.addEventListener("controllerconnected",function(t){console.log(t),e.controllerModel=t.detail.name,null==e.model?e.isGamepadConnected=!0:e.updateWeapon()}),t.addEventListener("model-loaded",function(e){this.model=e.detail.model;var i=new THREE.Group;i.add(this.model),t.setObject3D("mesh",i);for(var s=0;s<3;s++){var n=this.model.getObjectByName("fire"+s);n&&(n.material.depthWrite=!1,n.visible=!1,this.fires.push(n))}this.isGamepadConnected&&this.updateWeapon(),this.trigger=this.model.getObjectByName("trigger")}.bind(this));var e=this;t.addEventListener("shoot",function(i){t.components["json-model"].playAnimation("default"),e.light.components.light.light.intensity=e.lightIntensity;for(var s in e.fires)e.fires[s].visible=!0,
e.fires[s].life=50+100*Math.random()}),this.lightIntensity=3,this.life=this.data.lifespan,this.canShoot=!0,this.light=document.createElement("a-entity"),t.appendChild(this.light),this.light.setAttribute("light",{color:"#ffc724",intensity:0,type:"point"}),this.light.setAttribute("position",{x:0,y:-.22,z:-.14});var e=this;this.light.addEventListener("loaded",function(){e.lightObj=e.light.components.light.light})},tick:function(t,e){if(this.lightObj&&this.lightObj.intensity>0){this.light.visible=!0,this.lightObj.intensity-=e/1e3*10,this.lightObj.intensity<0&&(this.lightObj.intensity=0,this.light.visible=!1);for(var i in this.fires)this.fires[i].visible&&(this.fires[i].life-=e,0==i?this.fires[i].rotation.set(0,Math.random()*Math.PI*2,0):this.fires[i].rotation.set(0,1*Math.random()-.5+(Math.random()>.5?Math.PI:0),0),this.fires[i].life<0&&(this.fires[i].visible=!1))}},update:function(){var t=this.data;this.weapon=i[t.type]},setTriggerPressure:function(t){this.trigger&&this.trigger.position.setY(.01814*t)}}),t.exports=i},function(t,e,i){var s=i(22);AFRAME.registerComponent("shoot",{schema:{direction:{type:"vec3",default:{x:0,y:-2,z:-1}},on:{default:"triggerdown"},spaceKeyEnabled:{default:!1},weapon:{default:"default"}},init:function(){var t=this.data,e=this.el,i=this;this.coolingDown=!1,this.shoot=this.shoot.bind(this),this.weapon=null,t.on&&e.addEventListener(t.on,this.shoot),t.spaceKeyEnabled&&window.addEventListener("keydown",function(t){"Space"!==t.code&&"32"!==t.keyCode||i.shoot()}),AFRAME.utils.device.isMobile()&&window.addEventListener("click",function(t){i.shoot()})},update:function(t){this.weapon=s[this.data.weapon],t.on!==this.data.on&&(this.el.removeEventListener(t.on,this.shoot),this.el.addEventListener(this.data.on,this.shoot))},shoot:function(){var t=new THREE.Vector3,e=new THREE.Vector3,i=new THREE.Quaternion,s=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3(0,-.23,-.15),a=new THREE.Vector3(0,-.23,-.8),r=new THREE.Vector3;return function(){var l,h,c=this.el,d=this.data,u=this,m=this.weapon;this.coolingDown||(PEWVR.currentScore.shoots++,c.object3D.updateMatrixWorld(),h=c.object3D.matrixWorld,e.setFromMatrixPosition(h),h.decompose(n,i,s),t.set(d.direction.x,d.direction.y,d.direction.z),t.applyQuaternion(i),t.normalize(),c.components.weapon&&r.copy("oculus-touch-controller"===c.components.weapon.controllerModel?a:o),r.applyQuaternion(i),e.add(r),l=c.sceneEl.systems.bullet.getBullet(m.bullet),l.setAttribute("position",e),l.setAttribute("bullet",{direction:t.clone(),position:e.clone(),owner:"player"}),l.setAttribute("visible",!0),l.setAttribute("position",e),l.play(),c.emit("shoot",l),this.coolingDown=!0,setTimeout(function(){u.coolingDown=!1},m.shootingDelay))}}()})},function(t,e){AFRAME.registerComponent("headset",{schema:{on:{default:"click"}},init:function(){},tick:function(t,e){var i=this.el.getObject3D("mesh");i&&i.update(e/1e3),this.updatePose(),this.updateButtons()},updatePose:function(){var t=new THREE.Euler,e=new THREE.Vector3,i=new THREE.Quaternion,s=new THREE.Object3D,n=new THREE.Matrix4;return t.order="YXZ",function(){var o,a,r,l,h=this.el,c=this.system.vrDisplay;this.update(),o=this.controller,o&&(a=o.pose,r=a.orientation||[0,0,0,1],l=a.position||[0,0,0],i.fromArray(r),s.quaternion.fromArray(r),s.position.fromArray(l),s.updateMatrix(),c&&c.stageParameters&&(n.fromArray(c.stageParameters.sittingToStandingTransform),s.applyMatrix(n)),t.setFromRotationMatrix(s.matrix),e.setFromMatrixPosition(s.matrix),h.setAttribute("rotation",{x:THREE.Math.radToDeg(t.x),y:THREE.Math.radToDeg(t.y),z:THREE.Math.radToDeg(t.z)}),h.setAttribute("position",{x:e.x,y:e.y,z:e.z}))}}()})},function(t,e){AFRAME.registerComponent("json-model",{schema:{src:{type:"asset"},singleModel:{default:!1},texturePath:{type:"asset",default:""},debugNormals:{default:!1},debugNormalsLength:{default:.2},debugBones:{default:!1}},init:function(){},fixNormal:function(t){var e=t.y;t.y=-t.z,t.z=e},update:function(t){this.loader=null,this.helpers=new THREE.Group,this.mixers=[],this.animationNames=[],this.skeletonHelper=null;var e=this.data.src;e&&e!==t.src&&(this.data.singleModel?(this.loader=new THREE.JSONLoader,this.loader.setTexturePath(this.data.texturePath),this.loader.load(e,this.onModelLoaded.bind(this))):(this.loader=new THREE.ObjectLoader,this.loader.setCrossOrigin(""),this.loader.load(e,this.onSceneLoaded.bind(this))))},onModelLoaded:function(t,e){this.helpers=new THREE.Group;var i=new THREE.SkinnedMesh(t,e[0]),s=this;if(i.geometry.faces.forEach(function(t){t.vertexNormals.forEach(function(t){t.hasOwnProperty("fixed")||(s.fixNormal(t),t.fixed=!0)})}),void 0!==i.geometry.animations&&i.geometry.animations.length>0){i.material.skinning=!0;var n={mixer:new THREE.AnimationMixer(i),clips:{}};for(var o in i.geometry.animations){var a=i.geometry.animations[o],r=n.mixer.clipAction(a).stop();r.setEffectiveWeight(1),n.clips[a.name]=r}this.mixers.push(n)}s.addNormalHelpers(i),this.helpers.visible=this.data.debugNormals,this.el.setObject3D("helpers",this.helpers),this.skeletonHelper=new THREE.SkeletonHelper(i),this.skeletonHelper.material.linewidth=2,this.el.setObject3D("skelhelper",this.skeletonHelper),this.skeletonHelper.visible=this.data.debugBones,this.el.setObject3D("mesh",i),this.el.emit("model-loaded",{format:"json",model:i,src:this.data.src})},onSceneLoaded:function(t){if(this.helpers=new THREE.Group,void 0!==t.animations){var e={mixer:new THREE.AnimationMixer(t),clips:{}};for(var i in t.animations){var s=t.animations[i],n=e.mixer.clipAction(s).stop();e.clips[s.name]=n}this.mixers.push(e)}var o=this;t.traverse(function(t){t instanceof THREE.Mesh&&(t.geometry.faces.forEach(function(t){t.vertexNormals.forEach(function(t){t.hasOwnProperty("fixed")||(o.fixNormal(t),t.fixed=!0)})}),o.addNormalHelpers(t))}),this.helpers.visible=this.data.debugNormals,this.el.setObject3D("helpers",this.helpers),this.el.setObject3D("mesh",t),this.el.emit("model-loaded",{format:"json",model:t,src:this.data.src})},addNormalHelpers:function(t){var e=new THREE.FaceNormalsHelper(t,this.data.debugNormalsLength);this.helpers.add(e);var i=new THREE.VertexNormalsHelper(t,this.data.debugNormalsLength);this.helpers.add(i),t.geometry.normalsNeedUpdate=!0,t.geometry.verticesNeedUpdate=!0},playAnimation:function(t,e){for(var i in this.mixers){var s=this.mixers[i].clips[t];if(void 0!==s){s.stop().play();var n=0;e===!0?n=1/0:void 0==e?e=!1:"number"==typeof e?(0===e&&(e=!1),n=e):e=!1,s.setLoop(e?THREE.LoopRepeat:THREE.LoopOnce,n)}}},stopAnimation:function(){for(var t in this.mixers)for(var e in this.mixers[t].clips)this.mixers[t].clips[e].stop()},tick:function(t,e){for(var i in this.mixers)this.mixers[i].mixer.update(e/1e3)}})},function(t,e){AFRAME.registerComponent("spline-line",{schema:{pointer:{default:""},numPoints:{default:250}},init:function(){function t(){for(var t=s.pointer.split("."),e=t.shift(),i=n.components[e];t.length;){if(!i)return;i=i[t.shift()]}return i}var e,i,s=this.data,n=this.el,o=this;this.pointMeshes=[],i=t(),i?this.drawLine(i):(e=s.pointer.split(".")[0],n.addEventListener("componentchanged",function(i){i.detail.name===e&&o.drawLine(t())}))},drawLine:function(t){var e,i,s,n=this.data,o=this.el,a=this.pointMeshes;for(e=new THREE.Geometry,s=new THREE.LineBasicMaterial({color:new THREE.Color(Math.random(),Math.random(),Math.random())}),i=0;i<n.numPoints;i++){var r=t.getPoint(i/n.numPoints);e.vertices.push(new THREE.Vector3(r.x,r.y,r.z))}e.verticesNeedsUpdate=!0,t.points.forEach(function(t){var e=new THREE.SphereGeometry(.2,16,16),i=new THREE.MeshBasicMaterial({color:"#111"}),s=new THREE.Mesh(e,i);s.position.set(t.x,t.y,t.z),a.push(s),o.sceneEl.object3D.add(s)}),this.line=new THREE.Line(e,s),o.sceneEl.object3D.add(this.line)},remove:function(){var t=this.el.sceneEl.object3D;this.line&&(t.remove(this.line),this.pointMeshes.forEach(function(e){t.remove(e)}))}})},function(t,e){AFRAME.registerComponent("explosion",{schema:{type:{default:"enemy",oneOf:["enemy","bullet","background","enemygun"]},duration:{default:500},color:{type:"color",default:"#FFFFFF"},lookAt:{type:"vec3",default:null},scale:{default:1}},update:function(t){"enemy"===this.data.type?(this.materials[2].color.set(this.data.color),this.materials[4].color.set(this.data.color)):"bullet"===this.data.type?(this.data.scale*=.5,this.materials[0].color.set(this.data.color),this.materials[2].color.set(this.data.color)):"enemygun"===this.data.type?(this.materials[0].color.set(this.data.color),this.data.duration=300):"background"===this.data.type&&(this.data.duration=300);for(var e=0;e<this.meshes.children.length;e++){var i=this.meshes.children[e];i.part.billboard&&this.data.lookAt&&i.lookAt(this.data.lookAt)}this.el.setAttribute("scale",{x:this.data.scale,y:this.data.scale,z:this.data.scale})},init:function(){function t(t,e){this.materials[t].alphaMap=e,this.materials[t].needsUpdate=!0,this.materials[t].visible=!0}this.life=0,this.starttime=null,this.meshes=new THREE.Group,this.materials=[];var e=new Array("#fx1","#fx2","#fx3","#fx4","#fx8");switch(this.el.setAttribute("scale",{x:this.data.scale,y:this.data.scale,z:this.data.scale}),this.data.type){case"enemy":this.parts=[{textureIdx:2,billboard:!0,color:16777215,scale:1.5,grow:4,dispersion:0,copies:1,speed:0},{textureIdx:0,billboard:!0,color:16777215,scale:.4,grow:2,dispersion:2.5,copies:1,speed:1},{textureIdx:3,billboard:!1,color:this.data.color,scale:1,grow:6,dispersion:0,copies:1,speed:0},{textureIdx:1,billboard:!0,color:16577633,scale:.04,grow:2,dispersion:3,copies:20,speed:2},{textureIdx:3,billboard:!0,color:this.data.color,scale:.2,grow:2,dispersion:2,copies:5,speed:1}];break;case"bullet":this.parts=[{textureIdx:2,billboard:!0,color:this.data.color,scale:.5,grow:3,dispersion:0,copies:1,speed:0},{textureIdx:4,billboard:!0,color:"#24CAFF",scale:.3,grow:4,dispersion:0,copies:1,speed:0},{textureIdx:0,billboard:!0,color:this.data.color,scale:.04,grow:2,dispersion:1.5,copies:8,speed:1}];break;case"background":this.parts=[{textureIdx:4,billboard:!0,color:"#24CAFF",scale:.3,grow:3,dispersion:0,copies:1,speed:0},{textureIdx:0,billboard:!0,color:"#24CAFF",scale:.03,grow:1,dispersion:.3,copies:8,speed:1.6,noFade:!0}];break;case"enemygun":this.parts=[{textureIdx:3,billboard:!0,color:this.data.color,scale:.5,grow:3,dispersion:0,copies:1,speed:0}]}for(var i in this.parts){var s=this.parts[i];s.meshes=[];var n=new THREE.PlaneGeometry(s.scale,s.scale),o=new THREE.MeshBasicMaterial({color:s.color,side:THREE.DoubleSide,transparent:!0,blending:THREE.AdditiveBlending,depthTest:!0,depthWrite:!1,visible:!1});o.noFade=s.noFade===!0,this.materials.push(o);var a=document.querySelector(e[s.textureIdx]).getAttribute("src");this.el.sceneEl.systems.material.loadTexture(a,{src:a},t.bind(this,i));for(var r=s.dispersion/2,l=0;l<s.copies;l++){var h=new THREE.Mesh(n,o);s.billboard?this.data.lookAt&&h.lookAt(this.data.lookAt):h.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),s.dispersion>0&&(h.position.set(Math.random()*s.dispersion-r,Math.random()*s.dispersion-r,Math.random()*s.dispersion-r),h.speed=s.speed+Math.random()/s.dispersion),h.part=s,this.meshes.add(h),s.meshes.push(h)}}this.el.setObject3D("explosion",this.meshes)},reset:function(){this.life=0,this.starttime=null;for(var t in this.parts)for(var e=this.parts[t],i=e.dispersion/2,s=0;s<e.copies;s++){var n=e.meshes[s];e.billboard?this.data.lookAt&&n.lookAt(this.data.lookAt):n.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2),e.dispersion>0&&(n.position.set(Math.random()*e.dispersion-i,Math.random()*e.dispersion-i,Math.random()*e.dispersion-i),n.speed=e.speed+Math.random()/e.dispersion)}this.starttime=null,this.system.returnToPool(this.data.type,this.el)},tick:function(t,e){if(null===this.starttime&&(this.starttime=t),this.life=(t-this.starttime)/this.data.duration,this.life>1)return void this.reset();for(var i=this.life*(2-this.life),s=0;s<this.meshes.children.length;s++){var n=this.meshes.children[s],o=1+i*n.part.grow;n.scale.set(o,o,o),n.part.speed>0&&n.position.multiplyScalar(1+e/1e3*n.speed)}for(var s in this.materials)this.materials[s].noFade||(this.materials[s].opacity=1-i)}})},function(t,e){AFRAME.registerComponent("animate-message",{init:function(){var t=this;this.startMsg=null,this.el.addEventListener("model-loaded",function(e){t.startMsg=t.el.getObject3D("mesh").getObjectByName("start")})},tick:function(t,e){this.startMsg&&(this.startMsg.rotation.z=-Math.PI+Math.abs(.03*Math.sin(t/200)))}})},function(t,e){AFRAME.registerComponent("gamestate-visuals",{schema:{},init:function(){this.logo=document.getElementById("logo"),this.startEnemy=document.getElementById("start_enemy"),this.mainMenuGroup=document.getElementById("mainmenu"),this.messageGroup=document.getElementById("message-group"),this.gameover=document.getElementById("gameover-model"),this.welldone=document.getElementById("welldone-model"),this.reset=document.getElementById("reset");var t=this;this.el.sceneEl.addEventListener("gamestate-changed",function(e){"state"in e.detail.diff&&("STATE_PLAYING"===e.detail.state.state?t.startPlaying():"STATE_GAME_OVER"===e.detail.state.state?t.finishPlaying("GAME_OVER"):"STATE_GAME_WIN"===e.detail.state.state?t.finishPlaying("GAME_WIN"):"STATE_MAIN_MENU"===e.detail.state.state&&t.mainMenu())}.bind(this))},startPlaying:function(){var t=this,e={x:0},i=new AFRAME.TWEEN.Tween(e).to({x:.6*Math.PI},1e3).onComplete(function(){t.mainMenuGroup.setAttribute("visible",!1)}).easing(AFRAME.TWEEN.Easing.Back.InOut).onUpdate(function(){});i.start(),this.startEnemy.setAttribute("visible",!1)},finishPlaying:function(t){var e=this;this.reset.object3D.position.y=-5;var i={y:-5},s=new AFRAME.TWEEN.Tween(i).to({y:0},1e3).delay(3e3).easing(AFRAME.TWEEN.Easing.Elastic.Out).onUpdate(function(){e.reset.object3D.position.y=i.y});s.start()},mainMenu:function(){var t=this;this.startEnemy.setAttribute("position","0 -5 -4"),this.startEnemy.setAttribute("visible",!0),this.mainMenuGroup.setAttribute("visible",!0);var e={positionY:-5},i=new AFRAME.TWEEN.Tween(e).to({positionY:1.4},1e3).delay(1e3).easing(AFRAME.TWEEN.Easing.Back.InOut).onUpdate(function(){t.startEnemy.setAttribute("position",{x:0,y:e.positionY,z:-4})});i.start();var s=document.getElementById("finished");s.object3D.position.y=1;var n={y:1},o=new AFRAME.TWEEN.Tween(n).to({y:-5},1e3).easing(AFRAME.TWEEN.Easing.Elastic.In).onComplete(function(){s.setAttribute("visible",!1)}).onUpdate(function(){s.object3D.position.y=n.y});o.start(),this.logo.object3D.rotation.x=.6*Math.PI;var a={x:0},o=new AFRAME.TWEEN.Tween(a).to({x:.6*Math.PI},1e3).easing(AFRAME.TWEEN.Easing.Elastic.Out).delay(1e3).onUpdate(function(){});o.start()}})},function(t,e){AFRAME.registerComponent("sound-fade",{schema:{from:{default:0},to:{default:1},duration:{default:1e3}},init:function(){this.el.getAttribute("sound")?(this.el.setAttribute("sound","volume",this.data.from),this.fadeEnded=!1,this.diff=this.data.to-this.data.from):this.fadeEnded=!0},update:function(t){this.endTime=void 0,this.fadeEnded=!1,this.diff=this.data.to-this.data.from},tick:function(t,e){if(!this.fadeEnded){if(void 0===this.endTime)return void(this.endTime=t+this.data.duration);var i=1-(this.endTime-t)/this.data.duration;i=Math.max(0,Math.min(1,i*i));var s=this.data.from+this.diff*i;this.el.setAttribute("sound","volume",s),1===i&&(this.fadeEnded=!0)}}})},function(t,e){AFRAME.registerComponent("restrict-position",{schema:{},init:function(){this.active=!AFRAME.utils.device.checkHeadsetConnected(),this.radius=2},tick:function(t,e){if(this.active){var i=new THREE.Vector3,s=this.el.object3D.position.y;i.copy(this.el.object3D.position);var n=this.radius/i.length();n<.98&&(i.multiplyScalar(this.radius/i.length()),this.el.setAttribute("position",{x:i.x,y:s,z:i.z}))}}})}]);